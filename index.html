<!-- BEGIN Web3¬†Metal Challenge Voting Portal v3.2 -->
<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-950 text-gray-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Web3¬†Metal¬†Challenge Voting Portal</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="h-full flex flex-col" x-data="portal()">
  <!-- Header -->
  <header class="bg-gradient-to-r from-red-700/70 to-red-900/70 py-4 shadow-lg">
    <div class="max-w-5xl mx-auto px-4 flex items-center justify-between">
      <h1 class="text-3xl font-bold tracking-wider select-none">Web3¬†Metal¬†Challenge</h1>
      <template x-if="phase==='submit'"><span class="italic text-sm">Submit your track ‚ÜØ</span></template>
      <template x-if="phase==='judge'"><span class="italic text-sm">Judging in progress ‚öñÔ∏è</span></template>
      <template x-if="phase==='party'"><span class="italic text-sm">Listening Party soon üéß</span></template>
      <template x-if="phase==='results'"><button class="text-sm underline" @click="showResults=true; computeScores()">View Results</button></template>
    </div>
  </header>

  <!-- Main -->
  <main class="flex-1 overflow-y-auto max-w-5xl mx-auto w-full px-4 py-6">

    <!-- Public landing / submit placeholder -->
    <template x-if="phase==='submit' && !isJudge">
      <div class="text-center space-y-4">
        <p class="text-lg">Demo challenge loaded from inline defaults. Edit via <code>#admin</code>.</p>
        <p class="text-2xl font-semibold">Submit your track</p>
      </div>
    </template>

    <!-- Judge voting screen -->
    <template x-if="isJudge">
      <div class="space-y-8">
        <template x-for="song in config.songs" :key="song.id">
          <section class="bg-gray-900/60 p-4 rounded-lg shadow-md">
            <div class="flex gap-4 items-start">
              <template x-if="song.artworkUrl"><img :src="song.artworkUrl" alt="art" class="w-20 h-20 object-cover rounded shadow"/></template>
              <div>
                <h2 class="text-xl font-bold" x-text="song.title"></h2>
                <p class="text-sm text-gray-400" x-text="song.artist"></p>
              </div>
            </div>
            <div class="mt-4 space-y-4">
              <template x-for="(crit,cidx) in config.criteria" :key="crit.id">
                <div>
                  <!-- slider -->
                  <template x-if="crit.type==='slider'">
                    <div>
                      <label class="block text-sm mb-1" x-text="crit.settings.label + ' ('+crit.settings.weight+'√ó)'"></label>
                      <input type="range" min="0" :max="crit.settings.max||10"
                        class="w-full" x-model.number.lazy="votes[song.id]?.[crit.id]"
                        @input="updateVote(song.id, crit.id, $event.target.value)" />
                      <span class="text-xs" x-text="votes[song.id]?.[crit.id] ?? 0"></span>
                    </div>
                  </template>
                  <!-- checkbox -->
                  <template x-if="crit.type==='checkbox'">
                    <label class="flex items-center gap-2 text-sm">
                      <input type="checkbox"
                        :checked="votes[song.id]?.[crit.id] ?? crit.settings.checked"
                        @change="updateVote(song.id, crit.id, $event.target.checked)" />
                      <span x-text="crit.settings.label + ' ('+crit.settings.score+')'"></span>
                    </label>
                  </template>
                </div>
              </template>
            </div>
          </section>
        </template>
        <button class="bg-red-700 hover:bg-red-600 px-4 py-2 rounded" @click="saveVotes()">Save All Votes</button>
      </div>
    </template>

    <!-- Admin panel -->
    <template x-if="isAdmin">
      <div class="space-y-8">
        <!-- SONG BUILDER -->
        <section>
          <h2 class="text-2xl font-semibold mb-4">Songs</h2>
          <template x-for="(song, idx) in config.songs" :key="song.id">
            <div :key="song.id" x-data="{ expanded:false }" x-init="if(!song.title){ $nextTick(()=> $refs.title.focus()) }" class="border border-gray-700 rounded-lg p-4 mb-4">
              <!-- basic row -->
              <div class="flex flex-wrap gap-2 items-center">
                <input x-ref="title" class="bg-gray-800 px-2 py-1 rounded w-40" placeholder="Title" x-model.lazy="song.title"
                  @blur="if(!song.title.trim()){ $dispatch('remove-song', {idx}) }">
                <input class="bg-gray-800 px-2 py-1 rounded w-40" placeholder="Artist" x-model.lazy="song.artist">
                <input class="bg-gray-800 px-2 py-1 rounded flex-1" placeholder="Listen URL" x-model.lazy="song.listenUrl">
                <button class="text-xs" @click="expanded=!expanded">‚öôÔ∏è</button>
                <button class="text-xs" @click="$dispatch('move-song', {idx,-1})">‚ñ≤</button>
                <button class="text-xs" @click="$dispatch('move-song', {idx,1})">‚ñº</button>
                <button class="text-xs text-red-400" @click="config.songs.splice(idx,1)">üóëÔ∏è</button>
              </div>
              <!-- advanced -->
              <div x-show="expanded" class="mt-3 space-y-2">
                <input class="bg-gray-800 px-2 py-1 rounded w-full" placeholder="Artist URL" x-model.lazy="song.artistUrl">
                <input class="bg-gray-800 px-2 py-1 rounded w-full" placeholder="Artwork URL" x-model.lazy="song.artworkUrl">
                <textarea rows="2" class="bg-gray-800 px-2 py-1 rounded w-full" placeholder="Embed HTML" x-model.lazy="song.embedHtml"></textarea>
              </div>
            </div>
          </template>
          <button class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded" @click="addSong()">+ Add Song</button>
        </section>

        <!-- CRITERIA BUILDER -->
        <section>
          <h2 class="text-2xl font-semibold mb-4">Criteria</h2>
          <template x-for="(crit, idx) in config.criteria" :key="crit.id">
            <div :key="crit.id" x-data="{ }" x-init="if(!crit.settings.label){ $nextTick(()=> $refs.clabel.focus()) }" class="border border-gray-700 rounded-lg p-4 mb-4 flex flex-wrap gap-2 items-center">
              <select class="bg-gray-800 px-2 py-1 rounded" x-model="crit.type">
                <option value="slider">slider</option>
                <option value="checkbox">checkbox</option>
              </select>
              <input x-ref="clabel" class="bg-gray-800 px-2 py-1 rounded w-40" placeholder="Label" x-model.lazy="crit.settings.label"
                @blur="if(!crit.settings.label.trim()){ config.criteria.splice(idx,1) }">
              <template x-if="crit.type==='slider'">
                <>
                  <input type="number" class="bg-gray-800 px-2 py-1 rounded w-20" placeholder="Max" x-model.number.lazy="crit.settings.max">
                  <input type="number" class="bg-gray-800 px-2 py-1 rounded w-20" placeholder="Weight" x-model.number.lazy="crit.settings.weight">
                </>
              </template>
              <template x-if="crit.type==='checkbox'">
                <input type="number" class="bg-gray-800 px-2 py-1 rounded w-24" placeholder="Score" x-model.number.lazy="crit.settings.score">
              </template>
              <button class="text-xs" @click="$dispatch('move-crit',{idx,-1})">‚ñ≤</button>
              <button class="text-xs" @click="$dispatch('move-crit',{idx,1})">‚ñº</button>
              <button class="text-xs text-red-400" @click="config.criteria.splice(idx,1)">üóëÔ∏è</button>
            </div>
          </template>
          <div class="flex gap-2">
            <button class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded" @click="addSlider()">+ Add Slider</button>
            <button class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded" @click="addCheckbox()">+ Add Checkbox</button>
          </div>
        </section>

        <!-- Save / Export -->
        <div class="flex gap-2">
          <button class="bg-red-700 hover:bg-red-600 px-4 py-2 rounded" @click="saveConfig()">Save Config</button>
          <button class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded" @click="exportConfig()">Export JSON</button>
        </div>
      </div>
    </template>

    <!-- Results overlay -->
    <template x-if="showResults">
      <div class="fixed inset-0 bg-black/70 backdrop-blur flex items-center justify-center">
        <div class="bg-gray-900 p-6 rounded-lg w-full max-w-lg shadow-lg relative">
          <button class="absolute top-2 right-2 text-xl" @click="showResults=false">‚úñ</button>
          <h2 class="text-2xl font-semibold mb-4">Results</h2>
          <template x-for="(row, rIdx) in results" :key="row.song.id">
            <div class="flex items-center gap-3 py-1" :class="{'font-bold': rIdx<3}">
              <template x-if="rIdx===0">ü•á</template>
              <template x-if="rIdx===1">ü•à</template>
              <template x-if="rIdx===2">ü•â</template>
              <span x-text="row.song.title"></span>
              <span class="ml-auto" x-text="row.total.toFixed(1)"></span>
            </div>
          </template>
        </div>
      </div>
    </template>

  </main>

  <!-- Portal Alpine component -->
  <script>
  function slug(str){ return str.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-|-$|/g,'') }
  function portal(){
    return {
      // reactive state
      config: JSON.parse(localStorage.getItem('w3m-config') || JSON.stringify({
        submitUntil: '2030-01-01',
        judgeUntil:  '2030-02-01',
        listeningParty: '',
        criteria:[
          {id:'c1',type:'slider',settings:{label:'Riff Quality',max:10,weight:1}},
          {id:'c2',type:'checkbox',settings:{label:'Over 3 min penalty?',score:-10,checked:false}}
        ],
        songs:[
          {
            id:'s1',title:'One Shot One Slam',artist:'SlamDroid',artistUrl:'https://artist',artworkUrl:'https://picsum.photos/seed/1/200',listenUrl:'https://youtu.be/1',embedHtml:''
          }
        ],
        judges:['alpha','bravo']
      })),
      votes:{},
      results:[],
      judgeToken: new URLSearchParams(location.search).get('judge')||'',
      get phase(){
        const today = new Date().toISOString().split('T')[0];
        if(today <= this.config.submitUntil) return 'submit';
        if(today <= this.config.judgeUntil) return 'judge';
        return 'results';
      },
      get isJudge(){ return this.phase==='judge' && this.config.judges.includes(this.judgeToken) },
      get isAdmin(){ return location.hash.includes('admin') },
      showResults:false,
      // admin helpers
      addSong(){this.config.songs.push({id:'',title:'',artist:'',artistUrl:'',artworkUrl:'',listenUrl:'',embedHtml:''})},
      addSlider(){this.config.criteria.push({id:'',type:'slider',settings:{label:'',max:10,weight:1}})},
      addCheckbox(){this.config.criteria.push({id:'',type:'checkbox',settings:{label:'',score:0,checked:false}})},
      saveConfig(){ localStorage.setItem('w3m-config', JSON.stringify(this.config)); alert('Config saved'); },
      exportConfig(){ navigator.clipboard.writeText(JSON.stringify(this.config,null,2)); alert('Copied to clipboard') },
      // move events listener
      init(){
        this.$watch('config.songs', v=> v.forEach(s=>{ if(!s.id && s.title) s.id=slug(s.title) }))
        this.$watch('config.criteria', v=> v.forEach(c=>{ if(!c.id && c.settings.label) c.id=slug(c.settings.label) }))
        // load votes
        if(this.judgeToken){ this.votes = JSON.parse(localStorage.getItem('votes-'+this.judgeToken) || '{}') }
        // custom events for reordering
        this.$root.addEventListener('move-song', e=>{ const {idx,dir} = e.detail; const t_idx = idx+dir; if(t_idx<0||t_idx>=this.config.songs.length) return; [this.config.songs[idx],this.config.songs[t_idx]]=[this.config.songs[t_idx],this.config.songs[idx]] });
        this.$root.addEventListener('move-crit', e=>{ const {idx,dir} = e.detail; const t_idx = idx+dir; if(t_idx<0||t_idx>=this.config.criteria.length) return; [this.config.criteria[idx],this.config.criteria[t_idx]]=[this.config.criteria[t_idx],this.config.criteria[idx]] });
        this.$root.addEventListener('remove-song', e=>{ this.config.songs.splice(e.detail.idx,1) });
      },
      // judge helpers
      updateVote(sid,cid,val){
        if(!this.votes[sid]) this.votes[sid]={};
        this.votes[sid][cid] = val;
      },
      saveVotes(){ localStorage.setItem('votes-'+this.judgeToken, JSON.stringify(this.votes)); alert('Votes saved') },
      // results helpers
      computeScores(){
        // collect all votes blobs
        const votesColl = Object.keys(localStorage).filter(k=>k.startsWith('votes-')).map(k=> JSON.parse(localStorage.getItem(k)));
        this.results = this.config.songs.map(song=>{
          let total = 0; let judgeCount = 0;
          votesColl.forEach(vblob=>{
            if(!vblob[song.id]) return;
            judgeCount++;
            this.config.criteria.forEach(crit=>{
              const val = vblob[song.id][crit.id];
              if(crit.type==='slider') total += (Number(val)||0)*(crit.settings.weight||1);
              if(crit.type==='checkbox') total += (val? crit.settings.score:0);
            });
          });
          return {song,total: judgeCount? total:0};
        }).sort((a,b)=> b.total - a.total);
      }
    }
  }
  </script>
</body>
</html>
<!-- END Web3¬†Metal Portal v3.2 -->
