<!-- BEGIN Web3 Metal Challenge Voting Portal v3.3 -->
<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-950 text-gray-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Web3 Metal Challenge Voting Portal</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="h-full" x-data="portal()" x-init="init()">
  <!-- Notifications -->
  <template x-if="toast.show">
    <div class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-sm px-4 py-2 rounded shadow-lg animate-pulse" x-text="toast.msg"></div>
  </template>

  <!-- PUBLIC SECTION -->
  <div x-show="!isAdmin" class="p-6 max-w-3xl mx-auto text-center">
    <h1 class="text-3xl font-bold mb-2" x-text="config.name"></h1>
    <p class="opacity-70 mb-4" x-text="config.description"></p>

    <!-- Phase banners -->
    <template x-if="phase==='submit'">
      <div class="bg-blue-800/30 p-4 rounded mb-4">Submit your track before <span x-text="fmtDate(config.submitUntil)"></span></div>
    </template>
    <template x-if="phase==='judge' && !isJudge">
      <div class="bg-yellow-800/30 p-4 rounded mb-4">Judging in progress…</div>
    </template>
    <template x-if="phase==='judge' && isJudge">
      <!-- JUDGE DASHBOARD -->
      <div>
        <h2 class="text-xl font-semibold mb-2">Judge Panel</h2>
        <template x-for="song in config.songs" :key="song.id">
          <div class="bg-gray-800/60 p-4 rounded mb-4 text-left">
            <div class="flex items-center gap-4 mb-2">
              <img :src="song.artworkUrl || 'https://placehold.co/64x64'" class="w-16 h-16 object-cover rounded" />
              <div>
                <div class="font-semibold" x-text="song.title"></div>
                <div class="text-xs opacity-70" x-text="song.artist"></div>
              </div>
            </div>
            <!-- criteria loop -->
            <template x-for="crit in config.criteria" :key="crit.id">
              <div class="mb-3" x-data="{ val: initVote(song.id,crit.id) }" x-init="$watch('val',v=>saveVote(song.id,crit.id,v))">
                <template x-if="crit.type==='slider'">
                  <div>
                    <label class="block text-sm mb-1" x-text="crit.settings.label + ' ('+val+')'"></label>
                    <input type="range" min="0" max="10" x-model.number="val" class="w-full" />
                  </div>
                </template>
                <template x-if="crit.type==='checkbox'">
                  <label class="inline-flex items-center gap-2 text-sm">
                    <input type="checkbox" x-model="val" true-value="crit.settings.score" false-value="0" class="accent-red-600"/>
                    <span x-text="crit.settings.label + ' ('+crit.settings.score+')'"></span>
                  </label>
                </template>
              </div>
            </template>
          </div>
        </template>
        <button class="bg-green-700 hover:bg-green-600 px-4 py-2 rounded" @click="toastMsg('Votes saved locally')">Save</button>
      </div>
    </template>

    <template x-if="phase==='results'">
      <div>
        <h2 class="text-xl font-semibold mb-4">Results</h2>
        <table class="w-full text-left text-sm">
          <thead class="opacity-70">
            <tr><th>#</th><th>Song</th><th>Total</th></tr>
          </thead>
          <tbody>
            <template x-for="(row,idx) in results" :key="row.song.id">
              <tr class="border-t border-gray-700">
                <td class="pr-2" x-text="idx+1"></td>
                <td class="pr-2" x-text="row.song.title"></td>
                <td x-text="row.total.toFixed(2)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </template>
  </div>

  <!-- ADMIN PANEL -->
  <template x-if="isAdmin">
    <div class="min-h-screen p-6 max-w-5xl mx-auto" >
      <h1 class="text-3xl font-bold mb-4">Admin Console</h1>

      <!-- TABS -->
      <div class="flex gap-2 mb-4">
        <template x-for="t in tabs" :key="t">
          <button :class="tab===t?'bg-purple-700':'bg-gray-700 hover:bg-gray-600'" class="px-3 py-1 rounded text-sm" @click="tab=t" x-text="t"></button>
        </template>
      </div>

      <!-- GENERAL TAB -->
      <div x-show="tab==='General'" class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <label class="space-y-1"><span class="text-xs">Name</span><input class="w-full bg-gray-800 p-2 rounded" x-model="config.name"></label>
          <label class="space-y-1"><span class="text-xs">Description</span><input class="w-full bg-gray-800 p-2 rounded" x-model="config.description"></label>
          <label class="space-y-1"><span class="text-xs">Submit Until</span><input type="datetime-local" class="w-full bg-gray-800 p-2 rounded" x-model="config.submitUntil"></label>
          <label class="space-y-1"><span class="text-xs">Judge Until</span><input type="datetime-local" class="w-full bg-gray-800 p-2 rounded" x-model="config.judgeUntil"></label>
          <label class="space-y-1"><span class="text-xs">Listening Party (optional)</span><input type="datetime-local" class="w-full bg-gray-800 p-2 rounded" x-model="config.listeningParty"></label>
        </div>
        <button class="bg-green-700 px-4 py-2 rounded" @click="saveConfig">Save Config</button>
      </div>

      <!-- JUDGES TAB -->
      <div x-show="tab==='Judges'" class="space-y-4">
        <template x-for="(j,idx) in config.judges" :key="idx">
          <div class="flex items-center gap-2">
            <input class="bg-gray-800 p-2 rounded flex-1" x-model="config.judges[idx]" />
            <button class="text-red-400" @click="config.judges.splice(idx,1)">✖</button>
          </div>
        </template>
        <button class="bg-blue-700 px-3 py-1 rounded" @click="config.judges.push('')">Add Judge</button>
      </div>

      <!-- CRITERIA TAB -->
      <div x-show="tab==='Criteria'" class="space-y-4">
        <template x-for="(c,idx) in config.criteria" :key="c.id">
          <div class="bg-gray-800/60 p-3 rounded flex flex-col gap-2" x-data="{}">
            <div class="flex gap-2 items-center">
              <select class="bg-gray-700 p-1 rounded" x-model="c.type">
                <option value="slider">slider</option>
                <option value="checkbox">checkbox</option>
              </select>
              <input class="flex-1 bg-gray-700 p-1 rounded" x-model="c.settings.label" placeholder="label" />
              <label class="text-xs flex items-center gap-1">weight<input type="number" class="w-16 bg-gray-700 p-1 rounded" x-model.number="c.settings.weight"></label>
              <template x-if="c.type==='checkbox'">
                <label class="text-xs flex items-center gap-1">score<input type="number" class="w-16 bg-gray-700 p-1 rounded" x-model.number="c.settings.score"></label>
              </template>
              <button class="text-red-400" @click="config.criteria.splice(idx,1)">✖</button>
            </div>
            <div class="flex gap-1 text-xs">
              <button class="bg-gray-700 px-2 rounded" @click="move(config.criteria,idx,-1)">▲</button>
              <button class="bg-gray-700 px-2 rounded" @click="move(config.criteria,idx,1)">▼</button>
            </div>
          </div>
        </template>
        <button class="bg-blue-700 px-3 py-1 rounded" @click="addCriterion">Add Criterion</button>
      </div>

      <!-- SONGS TAB -->
      <div x-show="tab==='Songs'" class="space-y-4">
        <template x-for="(s,idx) in config.songs" :key="s.id">
          <div class="bg-gray-800/60 p-3 rounded" x-data="{ more:false }">
            <div class="flex gap-2 items-center mb-2">
              <input class="flex-1 bg-gray-700 p-1 rounded" x-model="s.title" placeholder="title" />
              <input class="flex-1 bg-gray-700 p-1 rounded" x-model="s.artist" placeholder="artist" />
              <input class="flex-1 bg-gray-700 p-1 rounded" x-model="s.listenUrl" placeholder="listen URL" />
              <button class="text-sm underline" @click="more=!more" x-text="more?'Less':'More ▾'"></button>
              <button class="text-red-400" @click="config.songs.splice(idx,1)">✖</button>
            </div>
            <div x-show="more" class="grid grid-cols-2 gap-2 text-sm">
              <input class="bg-gray-700 p-1 rounded" x-model="s.artistUrl" placeholder="artist URL" />
              <input class="bg-gray-700 p-1 rounded" x-model="s.artworkUrl" placeholder="artwork URL" />
              <textarea class="bg-gray-700 p-1 rounded col-span-2" rows="2" x-model="s.embedHtml" placeholder="embed HTML"></textarea>
            </div>
            <div class="flex gap-1 text-xs mt-2">
              <button class="bg-gray-700 px-2 rounded" @click="move(config.songs,idx,-1)">▲</button>
              <button class="bg-gray-700 px-2 rounded" @click="move(config.songs,idx,1)">▼</button>
            </div>
          </div>
        </template>
        <button class="bg-blue-700 px-3 py-1 rounded" @click="addSong">Add Song</button>
      </div>

      <!-- VOTES TAB -->
      <div x-show="tab==='Votes'" class="space-y-4">
        <input type="file" class="hidden" x-ref="file" @change="importVotes($event)" />
        <button class="bg-blue-700 px-3 py-1 rounded" @click="$refs.file.click()">Import Judge Votes JSON</button>
        <button class="bg-gray-700 px-3 py-1 rounded" @click="resetLocal">Reset Local Data</button>
      </div>
    </div>
  </template>

  <script>
  function portal(){
    return {
      config: {},
      defaultConfig: {
        name:'Web3 Metal Challenge',
        description:'Demo challenge loaded from inline defaults',
        submitUntil: new Date(Date.now()+86400000).toISOString().slice(0,16),
        judgeUntil: new Date(Date.now()+172800000).toISOString().slice(0,16),
        listeningParty:'',
        judges:['alpha'],
        criteria:[{
          id:'is_slam',type:'slider',settings:{label:'Is it actually slam?',weight:1}
        },{
          id:'over3',type:'checkbox',settings:{label:'Over 3 min penalty?',weight:1,score:-10}}
        ],
        songs:[{"id":"s1","title":"One Shot One Slam","artist":"SlamDroid","artistUrl":"","artworkUrl":"","listenUrl":"","embedHtml":""}]
      },
      isAdmin:false,
      isJudge:false,
      judgeToken:'',
      phase:'submit',
      results:[],
      tab:'General',
      tabs:['General','Judges','Criteria','Songs','Votes'],
      toast:{show:false,msg:''},
      init(){
        // get hash and query
        const params=new URLSearchParams(location.search);
        this.judgeToken=params.get('judge')||'';
        this.isAdmin=location.hash==="#admin";
        this.isJudge=!this.isAdmin && this.judgeToken;
        // load config
        this.config=JSON.parse(localStorage.getItem('w3m-config'))||this.defaultConfig;
        // phase detection
        const now=Date.now();
        if(now<new Date(this.config.submitUntil)){this.phase='submit'}
        else if(now<new Date(this.config.judgeUntil)){this.phase='judge'}
        else{this.phase='results'}
        // judge whitelist
        if(this.isJudge && !this.config.judges.includes(this.judgeToken)){this.isJudge=false}
        if(this.phase==='results'){this.computeResults()}
      },
      fmtDate(d){return new Date(d).toLocaleString()},
      toastMsg(m){this.toast.msg=m;this.toast.show=true;setTimeout(()=>this.toast.show=false,2000)},
      saveConfig(){localStorage.setItem('w3m-config',JSON.stringify(this.config));this.toastMsg('Config saved')},
      move(arr,idx,dir){const tgt=idx+dir;if(tgt<0||tgt>=arr.length)return;[arr[idx],arr[tgt]]=[arr[tgt],arr[idx]]},
      addCriterion(){const obj={id:'crit_'+Date.now(),type:'slider',settings:{label:'',weight:1,score:0}};this.config.criteria.push(obj);this.$nextTick(()=>this.$el.querySelector('input[placeholder=label]:last-child').focus())},
      addSong(){const obj={id:'song_'+Date.now(),title:'',artist:'',listenUrl:'',artistUrl:'',artworkUrl:'',embedHtml:''};this.config.songs.push(obj);this.$nextTick(()=>this.$el.querySelector('input[placeholder=title]:last-child').focus())},
      // VOTING
      votes(){return JSON.parse(localStorage.getItem('votes-'+this.judgeToken)||'{}')},
      initVote(sid,cid){const v=this.votes();return v[sid]?.[cid]??0},
      saveVote(sid,cid,val){let v=this.votes();v[sid]=v[sid]||{};v[sid][cid]=val;localStorage.setItem('votes-'+this.judgeToken,JSON.stringify(v))},
      importVotes(e){const file=e.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=ev=>{const data=JSON.parse(ev.target.result);const key='votes-'+(data.judge||'imported');localStorage.setItem(key,JSON.stringify(data));this.toastMsg('Votes imported')};reader.readAsText(file)},
      resetLocal(){localStorage.clear();this.toastMsg('localStorage wiped');setTimeout(()=>location.reload(),500)},
      // RESULTS
      loadAllVotes(){let out={};Object.keys(localStorage).filter(k=>k.startsWith('votes-')).forEach(k=>{const v=JSON.parse(localStorage.getItem(k)||'{}');out[k]=v});return out},
      totalForSong(songId,voteBlobs){let total=0;let judges=0;for(const vb of voteBlobs){const vs=vb[songId]||{};for(const c of this.config.criteria){const val=vs[c.id]??0;total+= (c.type==='slider'?val*c.settings.weight:val);}
        judges++;}
        return {total,avg:total/Math.max(judges,1)}},
      computeResults(){const votes=Object.values(this.loadAllVotes());this.results=this.config.songs.map(s=>{const t=this.totalForSong(s.id,votes);return {song:s,total:t.total}}).sort((a,b)=>b.total-a.total)},
    }
  }
  </script>
</body>
</html>
<!-- END v3.3 -->
