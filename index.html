<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-950 text-gray-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Web3 Metal Challenge Voting Portal</title>
  <!-- Tailwind (stand‑alone CDN build) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js for interactivity -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="h-full flex flex-col" x-data="portal()" x-init="init()">
  <!-- ========= PUBLIC LANDING ========= -->
  <main class="flex-1 flex flex-col items-center justify-center p-6 text-center space-y-6">
    <template x-if="config">
      <h1 class="text-4xl font-extrabold tracking-tight" x-text="config.name"></h1>
    </template>

    <p class="max-w-xl" x-text="config.description"></p>

    <!-- Phase banner -->
    <div class="px-4 py-2 rounded-lg shadow-md" :class="phaseBanner.bg">
      <span class="font-semibold" x-text="phaseBanner.text"></span>
      <template x-if="phase==='party'">
        <span class="ml-2" x-text="countdown"></span>
      </template>
    </div>

    <template x-if="phase==='submit'">
      <a :href="config.submissionForm" target="_blank" class="underline text-emerald-400 hover:text-emerald-300">Submit your track</a>
    </template>

    <template x-if="phase==='results'">
      <button class="px-4 py-2 bg-emerald-600 rounded-lg hover:bg-emerald-500" @click="showScoreboard=true">View Results</button>
    </template>
  </main>

  <!-- ========= SCOREBOARD ========= -->
  <div class="fixed inset-0 bg-black/80 backdrop-blur flex items-center justify-center p-6" x-show="showScoreboard" x-transition>
    <div class="bg-gray-900 w-full max-w-2xl rounded-xl p-6 space-y-4 relative">
      <button class="absolute right-4 top-4 text-xl" @click="showScoreboard=false">✕</button>
      <h2 class="text-2xl font-bold mb-4">Results</h2>
      <template x-if="scores.length===0">
        <p>No scores yet…</p>
      </template>
      <ul class="space-y-2" x-show="scores.length">
        <template x-for="row in scores" :key="row.song">
          <li class="flex justify-between border-b border-gray-700 pb-1">
            <span x-text="row.song"></span>
            <span class="font-mono" x-text="row.total.toFixed(2)"></span>
          </li>
        </template>
      </ul>
    </div>
  </div>

  <!-- ========= ADMIN PANEL ========= -->
  <div class="fixed inset-0 bg-black/80 backdrop-blur overflow-y-auto p-6" x-show="isAdmin" x-transition>
    <div class="bg-gray-900 w-full max-w-3xl mx-auto rounded-xl p-8 space-y-6">
      <h2 class="text-3xl font-bold mb-2">Challenge Settings</h2>
      <fieldset class="grid sm:grid-cols-2 gap-4">
        <label class="flex flex-col gap-1">
          <span>Name</span>
          <input type="text" class="p-2 bg-gray-800 rounded" x-model="config.name" />
        </label>
        <label class="flex flex-col gap-1 sm:col-span-2">
          <span>Description</span>
          <textarea rows="2" class="p-2 bg-gray-800 rounded" x-model="config.description"></textarea>
        </label>
        <label class="flex flex-col gap-1">
          <span>Submit Until</span>
          <input type="date" class="p-2 bg-gray-800 rounded" x-model="config.deadlines.submit" />
        </label>
        <label class="flex flex-col gap-1">
          <span>Judge Until</span>
          <input type="date" class="p-2 bg-gray-800 rounded" x-model="config.deadlines.judge" />
        </label>
        <label class="flex flex-col gap-1">
          <span>Listening Party (ISO datetime, optional)</span>
          <input type="datetime-local" class="p-2 bg-gray-800 rounded" x-model="config.listeningParty" />
        </label>
        <label class="flex flex-col gap-1">
          <span>Submission Form URL</span>
          <input type="url" class="p-2 bg-gray-800 rounded" x-model="config.submissionForm" />
        </label>
      </fieldset>

      <div class="flex gap-4 pt-4 border-t border-gray-700">
        <button class="px-4 py-2 bg-emerald-600 rounded hover:bg-emerald-500" @click="saveConfig">Save</button>
        <button class="px-4 py-2 bg-indigo-600 rounded hover:bg-indigo-500" @click="exportConfig">Export JSON</button>
        <label class="px-4 py-2 bg-amber-600 rounded hover:bg-amber-500 cursor-pointer">
          Import JSON
          <input type="file" class="hidden" @change="importConfig($event)" accept="application/json" />
        </label>
      </div>
    </div>
  </div>

  <!-- ========= TOAST ========= -->
  <div class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 px-4 py-2 rounded-lg" x-show="toast.show" x-text="toast.msg" x-transition></div>

  <!-- ========= SCRIPT ========= -->
  <script>
    function portal() {
      return {
        // reactive state
        config: null,
        phase: 'submit',
        showScoreboard: false,
        isAdmin: false,
        scores: [],
        toast: { show: false, msg: '' },
        countdown: '',
        // helpers
        init() {
          this.loadConfig();
          this.phase = this.getPhase();
          this.isAdmin = location.hash === '#admin';
          if (this.phase === 'party') this.startCountdown();
        },
        loadConfig() {
          const raw = localStorage.getItem('w3m-config');
          this.config = raw ? JSON.parse(raw) : this.demoConfig();
        },
        saveConfig() {
          localStorage.setItem('w3m-config', JSON.stringify(this.config));
          this.toastMsg('Config saved');
        },
        exportConfig() {
          const blob = new Blob([JSON.stringify(this.config, null, 2)], {type:'application/json'});
          const a = Object.assign(document.createElement('a'), { href: URL.createObjectURL(blob), download: 'challenge-config.json' });
          a.click(); URL.revokeObjectURL(a.href);
        },
        importConfig(e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = () => { this.config = JSON.parse(reader.result); this.saveConfig(); };
          reader.readAsText(file);
        },
        getPhase() {
          const today = new Date().setHours(0,0,0,0);
          const d = this.config.deadlines;
          if (today <= new Date(d.submit).setHours(0,0,0,0)) return 'submit';
          if (today <= new Date(d.judge).setHours(0,0,0,0)) return 'judge';
          if (this.config.listeningParty && new Date() < new Date(this.config.listeningParty)) return 'party';
          return 'results';
        },
        startCountdown() {
          const target = new Date(this.config.listeningParty);
          const pad = n => n.toString().padStart(2,'0');
          const tick = () => {
            const diff = target - Date.now();
            if (diff <= 0) return location.reload();
            const h = pad(Math.floor(diff/3600000));
            const m = pad(Math.floor(diff/60000)%60);
            const s = pad(Math.floor(diff/1000)%60);
            this.countdown = `${h}:${m}:${s}`;
            requestAnimationFrame(tick);
          }; tick();
        },
        phaseBanner() {
          switch(this.phase) {
            case 'submit': return { text: 'Submissions Open', bg: 'bg-emerald-700' };
            case 'judge':  return { text: 'Judging in Progress', bg: 'bg-indigo-700' };
            case 'party':  return { text: 'Listening Party Countdown', bg: 'bg-yellow-700' };
            default:       return { text: 'Results', bg: 'bg-purple-700' };
          }
        },
        get phaseBanner() { return this.phaseBanner(); },
        toastMsg(msg) {
          this.toast.msg = msg; this.toast.show = true;
          setTimeout(()=>this.toast.show=false, 2500);
        },
        // example config used on first load
        demoConfig() {
          return {
            name: 'Web3 Metal Challenge',
            description: 'Demo challenge loaded from inline defaults. Edit via #admin.',
            submissionForm: 'https://example.com',
            deadlines: { submit: '2025-06-30', judge: '2025-07-07' },
            listeningParty: '',
            criteria: [ { id:'riff', label:'Riff Quality', weight:1 } ],
            songs: [],
            judges: []
          };
        }
      }
    }
  </script>
</body>
</html>
