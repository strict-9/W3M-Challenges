<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-950 text-gray-100">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Web3Â MetalÂ Challenge Voting Portal</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Alpine.js -->
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="h-full" x-data="portal()" x-init="init()">
  <!-- Toast -->
  <template x-if="toast.show">
    <div class="fixed top-3 right-3 bg-gray-800 px-4 py-2 rounded shadow-lg border border-gray-700" x-text="toast.msg" x-transition></div>
  </template>

  <!-- Top bar -->
  <header class="p-4 border-b border-gray-800 flex justify-between items-center">
    <h1 class="text-2xl font-bold">Web3Â Metal Challenge</h1>
    <template x-if="phase==='judge' && judgeToken">
      <span class="text-xs bg-gray-800 px-2 py-1 rounded">Judge: <span x-text="judgeToken"></span></span>
    </template>
    <template x-if="hashAdmin">
      <span class="text-xs bg-yellow-600 px-2 py-1 rounded">Admin Mode</span>
    </template>
  </header>

  <!-- ===== PUBLIC LANDING ===== -->
  <main class="p-6 space-y-6 max-w-4xl mx-auto">
    <!-- Submit banner -->
    <template x-if="phase==='submit' && !hashAdmin && !isJudge">
      <div class="border border-gray-700 p-6 rounded text-center">
        <h2 class="text-xl font-semibold mb-2" x-text="config.name"></h2>
        <p class="mb-4" x-text="config.description"></p>
        <p class="font-bold text-lg text-indigo-400">Submit your track!</p>
      </div>
    </template>

    <!-- Judging banner -->
    <template x-if="phase==='judge' && !isJudge && !hashAdmin">
      <div class="border border-gray-700 p-6 rounded text-center">
        <p class="text-lg font-semibold">Judging in progressâ€¦</p>
      </div>
    </template>

    <!-- Party banner -->
    <template x-if="phase==='party' && !hashAdmin">
      <div class="border border-gray-700 p-6 rounded text-center">
        <h2 class="text-xl font-semibold mb-2">Listening Party</h2>
        <p x-text="countdown"></p>
      </div>
    </template>

    <!-- Results banner/button -->
    <template x-if="phase==='results' && !hashAdmin">
      <div class="text-center">
        <button @click="showResults=true; computeScores()" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded">View Results</button>
      </div>
    </template>
  </main>

  <!-- ===== RESULTS MODAL ===== -->
  <template x-if="showResults">
    <div class="fixed inset-0 bg-black/70 flex items-start justify-center pt-10" @click.self="showResults=false" x-transition>
      <div class="bg-gray-900 rounded-lg shadow-lg max-w-3xl w-full p-6 space-y-4">
        <h3 class="text-xl font-bold mb-4">Results</h3>
        <table class="w-full text-sm">
          <thead class="bg-gray-800 text-gray-300">
            <tr>
              <th class="px-2 py-1 text-left">Rank</th>
              <th class="px-2 py-1 text-left">Song</th>
              <th class="px-2 py-1 text-right">Score</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="(row, idx) in results" :key="row.id">
              <tr class="border-b border-gray-800 hover:bg-gray-800/50">
                <td class="px-2 py-1" x-text="medal(idx)"></td>
                <td class="px-2 py-1" x-text="row.title"></td>
                <td class="px-2 py-1 text-right" x-text="row.total.toFixed(2)"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </template>

  <!-- ===== VOTING DASHBOARD ===== -->
  <template x-if="isJudge && phase==='judge'">
    <div class="p-6 max-w-5xl mx-auto space-y-10">
      <template x-for="song in config.songs" :key="song.id">
        <div class="border border-gray-800 rounded p-4 space-y-4">
          <div class="flex justify-between items-center">
            <h2 class="font-semibold text-lg" x-text="song.title"></h2>
            <a :href="song.link" target="_blank" class="text-indigo-400 text-sm underline">Listen</a>
          </div>
          <!-- Criteria controls -->
          <div class="space-y-3">
            <template x-for="crit in config.criteria" :key="crit.id">
              <div>
                <!-- Slider UI -->
                <template x-if="crit.type==='slider' || !crit.type">
                  <div class="space-y-1">
                    <div class="flex justify-between">
                      <span x-text="crit.settings.label"></span>
                      <span class="text-xs text-gray-400" x-text="voteValue(song.id,crit.id)"></span>
                    </div>
                    <input type="range" min="0" max="10" step="1" :id="song.id+'-'+crit.id" x-model.number="votes[song.id][crit.id]" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                  </div>
                </template>
                <!-- Checkbox UI -->
                <template x-if="crit.type==='checkbox'">
                  <label class="flex items-center gap-2">
                    <input type="checkbox" x-model="votes[song.id][crit.id]" class="text-indigo-600"> <span x-text="crit.settings.label"></span>
                  </label>
                </template>
              </div>
            </template>
          </div>
        </div>
      </template>
      <button @click="saveVotes" class="bg-indigo-600 hover:bg-indigo-700 px-6 py-2 rounded">Save Votes</button>
    </div>
  </template>

  <!-- ===== ADMIN PANEL ===== -->
  <template x-if="hashAdmin">
    <div class="fixed inset-0 bg-black/70 flex items-start justify-center pt-10" x-transition>
      <div class="bg-gray-900 rounded-lg shadow-lg max-w-4xl w-full p-6 overflow-y-auto h-[90vh]" @click.outside="hashAdmin=false">
        <h2 class="text-xl font-bold mb-4">Challenge Settings</h2>

        <div class="space-y-4">
          <label class="block">Name <input x-model="config.name" class="mt-1 bg-gray-800 w-full p-2 rounded"></label>
          <label class="block">Description <textarea x-model="config.description" class="mt-1 bg-gray-800 w-full p-2 rounded"></textarea></label>

          <!-- Dates -->
          <div class="grid grid-cols-2 gap-4">
            <label class="block">Submit Until <input type="date" x-model="config.submitUntil" class="mt-1 bg-gray-800 w-full p-2 rounded"></label>
            <label class="block">Judge Until <input type="date" x-model="config.judgeUntil" class="mt-1 bg-gray-800 w-full p-2 rounded"></label>
            <label class="block col-span-2">Listening Party (optional) <input type="datetime-local" x-model="config.listeningParty" class="mt-1 bg-gray-800 w-full p-2 rounded"></label>
          </div>

          <!-- ===== CRITERIA BUILDER ===== -->
          <div class="border border-gray-700 p-4 rounded">
            <h3 class="font-semibold mb-2">Judging Criteria</h3>
            <template x-for="(crit, idx) in config.criteria" :key="crit.id">
              <div class="flex items-center gap-2 mb-2 bg-gray-800/40 p-2 rounded">
                <!-- reorder -->
                <div class="flex flex-col text-xs">
                  <button @click="idx>0 && swap(config.criteria, idx, idx-1)" title="Move up">â–²</button>
                  <button @click="idx < config.criteria.length-1 && swap(config.criteria, idx, idx+1)" title="Move down">â–¼</button>
                </div>
                <!-- type -->
                <select x-model="crit.type" class="bg-gray-800 rounded px-1 text-xs">
                  <option value="slider">slider</option>
                  <option value="checkbox">checkbox</option>
                </select>
                <!-- label -->
                <input x-model="crit.settings.label" placeholder="Label" class="bg-gray-800 rounded px-1 text-xs w-32">
                <!-- slider fields -->
                <template x-if="crit.type==='slider'">
                  <input type="number" x-model.number="crit.settings.weight" placeholder="weight" class="bg-gray-800 rounded px-1 text-xs w-16">
                </template>
                <!-- checkbox fields -->
                <template x-if="crit.type==='checkbox'">
                  <input type="number" x-model.number="crit.settings.score" placeholder="score" class="bg-gray-800 rounded px-1 text-xs w-16">
                  <label class="flex items-center gap-1 text-xs"><input type="checkbox" x-model="crit.settings.checked"> default</label>
                </template>
                <!-- delete -->
                <button @click="config.criteria.splice(idx,1)" class="text-red-400 text-xs px-1">âœ•</button>
              </div>
            </template>
            <div class="flex gap-2 mt-2">
              <button @click="addCriterion('slider')" class="bg-gray-700 rounded px-2 py-1 text-xs">+ Slider</button>
              <button @click="addCriterion('checkbox')" class="bg-gray-700 rounded px-2 py-1 text-xs">+ Checkbox</button>
            </div>
          </div>

          <!-- Buttons -->
          <div class="flex gap-3 pt-4">
            <button @click="saveConfig" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded">Save</button>
            <button @click="exportConfig" class="bg-gray-700 px-4 py-2 rounded">Export JSON</button>
            <label class="bg-gray-700 px-4 py-2 rounded cursor-pointer">Import JSON<input type="file" class="hidden" @change="importConfig($event)"></label>
            <label class="bg-gray-700 px-4 py-2 rounded cursor-pointer">Import Judge Votes<input type="file" class="hidden" @change="importVotes($event)"></label>
          </div>
        </div>
      </div>
    </div>
  </template>

  <script>
    function portal() {
      return {
        // state
        config: {},
        votes: {},
        judgeToken: '',
        phase: 'submit',
        hashAdmin: false,
        showResults: false,
        toast: {show:false,msg:''},
        results: [],
        countdown: '',

        // ===== INIT =====
        init() {
          this.hashAdmin = location.hash.includes('admin');
          const url = new URL(window.location.href);
          this.judgeToken = url.searchParams.get('judge') || '';

          this.loadConfig();
          this.computePhase();
          if (this.isJudge) this.initVotes();
          if (this.phase==='party') this.startCountdown();

          // re-evaluate on hash change
          window.addEventListener('hashchange', () => { this.hashAdmin = location.hash.includes('admin'); });
        },

        // ===== COMPUTED =====
        get isJudge() { return this.phase==='judge' && this.config.judges.includes(this.judgeToken); },

        // ===== CONFIG =====
        loadConfig() {
          const local = localStorage.getItem('w3m-config');
          this.config = local ? JSON.parse(local) : this.demoConfig();
        },
        saveConfig() {
          localStorage.setItem('w3m-config', JSON.stringify(this.config));
          this.toastMsg('Config saved');
        },
        exportConfig() {
          const blob = new Blob([JSON.stringify(this.config,null,2)], {type:'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href=url; a.download='challenge-config.json'; a.click(); URL.revokeObjectURL(url);
        },
        importConfig(e) {
          const file = e.target.files[0]; if(!file) return;
          file.text().then(txt=>{
            this.config = JSON.parse(txt);
            this.saveConfig();
            this.toastMsg('Config imported');
          });
        },

        // ===== PHASE & TIME =====
        computePhase() {
          const today = new Date().toISOString().split('T')[0];
          if (today <= this.config.submitUntil) this.phase='submit';
          else if (today <= this.config.judgeUntil) this.phase='judge';
          else if (this.config.listeningParty && new Date() <= new Date(this.config.listeningParty)) this.phase='party';
          else this.phase='results';
        },
        startCountdown() {
          const target = new Date(this.config.listeningParty);
          const tick = ()=>{
            const diff = target - new Date();
            if(diff<=0){this.phase='results'; return;}
            const h=Math.floor(diff/3.6e6), m=Math.floor((diff%3.6e6)/6e4), s=Math.floor((diff%6e4)/1e3);
            this.countdown=`Starts in ${h}h ${m}m ${s}s`;
            requestAnimationFrame(tick);
          };
          tick();
        },

        // ===== CRITERIA OPS =====
        addCriterion(type='slider') {
          const id = 'c'+Date.now();
          this.config.criteria.push(type==='slider'?{
            id, type:'slider', settings:{label:'New Slider', weight:1}
          }:{
            id, type:'checkbox', settings:{label:'New Checkbox', score:1, checked:false}
          });
        },
        swap(arr,i,j){[arr[i],arr[j]]=[arr[j],arr[i]];},

        // ===== VOTES =====
        initVotes() {
          const key='votes-'+this.judgeToken;
          const stored=localStorage.getItem(key);
          this.votes = stored?JSON.parse(stored):{};
          // ensure structure
          this.config.songs.forEach(s=>{
            if(!this.votes[s.id]) this.votes[s.id] = {};
            this.config.criteria.forEach(c=>{
              if(!(c.id in this.votes[s.id])) {
                this.votes[s.id][c.id] = c.type==='checkbox'?c.settings.checked:false;
              }
            });
          });
        },
        voteValue(songId,critId){return this.votes[songId][critId];},
        saveVotes(){
          localStorage.setItem('votes-'+this.judgeToken, JSON.stringify(this.votes));
          this.toastMsg('Votes saved locally');
        },
        exportVotes(){
          const blob = new Blob([JSON.stringify(this.votes,null,2)], {type:'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a'); a.href=url; a.download='votes-'+this.judgeToken+'.json'; a.click(); URL.revokeObjectURL(url);
        },
        importVotes(e){
          const file = e.target.files[0]; if(!file) return;
          const judge=file.name.replace(/\.json$/,'').split('votes-')[1]||'imported';
          file.text().then(t=>{
            localStorage.setItem('votes-'+judge,t);
            this.toastMsg('Votes from '+judge+' imported');
          });
        },

        // ===== RESULTS AGGREGATION =====
        computeScores(){
          const allVotes=this.loadAllVotes();
          const songTotals={};
          // init totals
          this.config.songs.forEach(s=>songTotals[s.id]={title:s.title,total:0});
          const judgeCount=Object.keys(allVotes).length||1;
          for(const [j,v] of Object.entries(allVotes)){
            for(const [songId,critMap] of Object.entries(v)){
              let subtotal=0;
              this.config.criteria.forEach(c=>{
                const val=critMap[c.id];
                if(c.type==='checkbox') subtotal += (val?c.settings.score:0);
                else subtotal += (val||0)*c.settings.weight;
              });
              songTotals[songId].total += subtotal;
            }
          }
          // average
          this.results = Object.entries(songTotals).map(([id,obj])=>({...obj,total:obj.total/judgeCount,id})).sort((a,b)=>b.total-a.total);
        },
        loadAllVotes(){
          const out={};
          Object.keys(localStorage).filter(k=>k.startsWith('votes-')).forEach(k=>{
            out[k.replace('votes-','')] = JSON.parse(localStorage.getItem(k));
          });
          return out;
        },
        medal(idx){return ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'][idx]||idx+1;},

        // ===== TOAST =====
        toastMsg(msg){this.toast.msg=msg; this.toast.show=true; setTimeout(()=>this.toast.show=false,2000);},

        // ===== DEMO CONFIG =====
        demoConfig(){
          return {
            name:'Demo Challenge',
            description:'Demo challenge loaded from inline defaults. Edit via #admin.',
            submitUntil:'2025-06-15',
            judgeUntil:'2025-06-22',
            listeningParty:'2025-06-23T20:00',
            criteria:[
              {id:'riff',type:'slider',settings:{label:'Riff Quality',weight:1}},
              {id:'mix',type:'slider',settings:{label:'Mix Clarity',weight:1}},
              {id:'kvlt',type:'checkbox',settings:{label:'KVLT bonus',score:5,checked:false}}
            ],
            songs:[
              {id:'s1',title:'Frost Hammer',link:'#'},
              {id:'s2',title:'Steel Skies',link:'#'}
            ],
            judges:['alpha','bravo']
          };
        }
      }
    }
  </script>
</body>
</html>
